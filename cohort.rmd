---
title: "Cohort characteristics"
output: html_notebook
---

```{r}
library(mbtools)
theme_set(theme_minimal())
```

```{r}
cohort <- rbind(
    fread("no_weight_loss.csv", colClasses=c(public_client_id="character")),
    fread("successful_weight_loss.csv", colClasses=c(public_client_id="character"))
)
cohort[, "subset" := "controls"]
cohort[weight_change_relative < 0, "subset" := "weight loss"]
cohort[, subset := factor(subset)]

subcohort <- fread("data/manifest.csv", colClasses = classes)[has_close_microbiome == T]
subcohort[, "public_client_id" := paste0("0", public_client_id)]

cohort[, "additional_assays" := FALSE]
cohort[public_client_id %chin% subcohort$public_client_id, "additional_assays" := TRUE]
```

```{r}
library(arivale.data.interface)
chem <- get_snapshot("chemistries", clean=T)
chem <- chem[cohort, on=c("public_client_id", "days_in_program"), roll="nearest"]
```

```{r, fig.width=4, fig.height=3}
ggplot(cohort, aes(x=since_baseline, y=bmi, group=public_client_id, color=additional_assays)) +
    geom_line(alpha=0.5, color="seagreen4") +
    geom_point() +
    labs(x="time in program [days]", y="BMI [kg/mÂ²]") +
    guides(color="none") +
    scale_color_manual(values=c("black", "tomato"))
ggsave("figures/bmi_trajectories.png", width=4, height=3, dpi=300)
```

```{r}
measures <- c("ADIPONECTIN__SERUM", "HDL_CHOL_DIRECT", "LDL_CHOL_CALCULATION", "GLUCOSE", "HOMA_IR", "INSULIN", "CRP_HIGH_SENSITIVITY", "GLYCOHEMOGLOBIN_A1C")
select <- chem[, c("public_client_id", "since_baseline", "additional_assays", measures), with=F]
select <- melt(select, id.vars=c("public_client_id", "since_baseline", "additional_assays"), value.name="value", variable.name="measure")

ggplot(select, aes(x=since_baseline, y=value, group=public_client_id, color=additional_assays)) +
    geom_line(alpha=0.5, color="seagreen4") +
    geom_point() +
    labs(x="time in program [days]", y="abundance [a.u.]") +
    facet_wrap(~ measure, scales="free_y") +
    guides(color="none") +
    scale_color_manual(values=c("black", "tomato")) 
ggsave("figures/other_trajectories.png", width=8, height=8, dpi=300)
```